var MongoClient = require('mongodb').MongoClient,
    CONFIG = require('config'),
    winston  = require('winston')

var MongoWrapper = module.exports = {
    connectionString : CONFIG.mongo.connectionString,
    /*
        save story to db
    */
    saveStory  : function(story,callback){
        //TODO  :extract common method of MongoClient.connect which get's the execution function as param
        MongoClient.connect(CONFIG.mongo.connectionString,function(err,db){
            console.log(err!==null);
            db.collection("story").findOne({_id:story._id},function(err,results){
                console.log("The result is:",results);
                if(results){
                    console.log("Story found",results);
                    _.extend(results,story);
                    db.collection("story").update(results,{_id:story._id},function (err, results) {

                        if(callback){
                            callback({"status":true,story:story});
                        }


                    });
                }
                else{
                    console.log("Insert new story",story);
                    db.collection("story").insert(story, function (err, results) {

                        if(callback){
                            callback({"status":true,story:story});
                        }


                    });
                }


            });
        });
    },

    /*
        get user
    */
    getUser : function(){
        keentour.collection("user").findOne({id:req.session.passport.user.profile.id},function(err,results){
            console.log("User in index is : ",results);
            res.render('index', { title:' KeenTour - explore the beauty of the world!',user :results || {} });

        });
    }
};

