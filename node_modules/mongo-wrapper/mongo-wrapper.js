var MongoClient = require('mongodb').MongoClient,
    CONFIG = require('config'),
    winston  = require('winston'),
    _  = require('underscore')

var MongoWrapper = module.exports = {
    connectionString : CONFIG.mongo.connectionString,

    executeQuery : function(func){
        console.log("Excuting function:"  + func.toString());
        MongoClient.connect(MongoWrapper.connectionString,function(err,db){
           if(err!==null){
              //TODO  : log hear
           }
           try{
                func(err,db);
           }
            catch(e){
                //TODO  : log here
            }

        });

    },


    /*
        save story to db
    */
    saveStory  : function(story,callback){
        var saveQuery = function(err,db){
            console.log("In function save story");
            db.collection("story").findOne( { $or : [{_id:story._id},{title:story.title}] } ,function(err,results){
            console.log("The result is:",results);
                if(results){
                    console.log("Story found",results);
                    _.extend(results,story);
                    db.collection("story").update(results,{_id:story._id},function (err, results) {

                        if(callback){
                            callback({"status":true,story:story});
                        }


                    });
                }
                else{
                    console.log("Insert new story",story);
                    db.collection("story").insert(story, function (err, results) {

                        if(callback){
                            callback({"status":true,story:story});
                        }


                    });
                }


            });
        }
        MongoWrapper.executeQuery(saveQuery);
    },

    /*
        get user
    */
    getUser : function(){
        keentour.collection("user").findOne({id:req.session.passport.user.profile.id},function(err,results){
            console.log("User in index is : ",results);
            res.render('index', { title:' KeenTour - explore the beauty of the world!',user :results || {} });

        });
    }
};

