define(["jquery","ajax-scroll","moment","twitter_grid","css!storiesListCss"],function(e,t,n,r){var i={config:{LATEST_STORIES_URL:"/latestStories"},storiesRequestParams:{rowsToSkip:0,storiesToShow:12,dateFormat:n,userName:null,editMode:!1,lastStoryId:null,itemsPerRow:3},searchStories:function(t,n){e(t).empty(),i.showLatest(t,n)},showLatest:function(t,n){i.storiesRequestParams=e.extend(!0,i.storiesRequestParams,n),i._bindInfiniteScroll(t),i._getStories(t)},_bindInfiniteScroll:function(t){e(window).paged_scroll({handleScroll:function(e,n,r){i.storiesRequestParams.rowsToSkip=e*i.storiesRequestParams.storiesToShow,i._getStories(t),r()},startPage:1,targetElement:e(t),step:"50%",debug:!1,monitorTargetChange:!1})},_getStories:function(e){var t=function(t){i._render(t,e)};i._getLatestStories(t)},_getLatestStories:function(t){var n=e.ajax({url:i.config.LATEST_STORIES_URL,dataType:"json",data:i.storiesRequestParams,cache:!1});n.success(function(e){t(e)}),n.error(function(e){i.render(null)})},_render:function(t,n){if(!t)return;r.gridify({element:n,data:t,itemsPerRow:i.storiesRequestParams.itemsPerRow,getItemContent:function(t,n,r){if(t){var s=e('<div class="storyCont" data-content="contentItem" />').appendTo(n);i._renderStory(t,s)}}})},_renderStory:function(t,r){var s=t.title,o=t.tags,u=t.items[0],a=t.url,f=n(t.publishDate).fromNow(),l=t.interests?t.interests.join(" "):"",c=i._getBigImageUrl(u);if(i.storiesRequestParams.editMode)var h=t.isPublished;if(t.storyUserText)var p=e("<div class='storyUserText'>"+t.storyUserText+"</div>").appendTo(r);var d=e("<div class='storyHeader'></div>").appendTo(r),v=e('<div class="widgetItemName" />').appendTo(d);e('<a class="storyContainer" href="'+a+'">'+s+"<a/>").appendTo(v);var m=e('<div class="storyImageCont"><a class="storyContainer" href="'+a+'"><img class="imgStory" src="'+c+'"/></a></div>').appendTo(r);e(".imgStory",r).css({height:u.height_s,width:u.width_s}),e('<div class="tags"><div class="tagsTitle">Tags</div><div class="tagsText"> '+l+"</div></div>").appendTo(r),e('<div class="userLink"><span>By : </span><a href="/stories/'+t.userName+'">'+t.userName+"</a></div>").appendTo(r);if(i.storiesRequestParams.editMode){var g=e('<div class="editLinks"><a class="editStory" href="'+t.editUrl+'">Edit</a><a class="deleteStory" href="'+t.deleteUrl+'">Delete<a></div>').appendTo(r);h?e("<span class='isPublished'>Published</span>").appendTo(g):e("<span class='draft'>Draft</span>").appendTo(g),e(".deleteStory",g).on("click",function(t){t.preventDefault();var n=confirm("Are you really want to delete this story?"),s=e(this).attr("href");n&&i._deleteStory(s,r)})}},_deleteStory:function(t,n){var r=e.ajax({url:t,dataType:"json",cache:!1});r.success(function(t){t.status==="ok"&&e(n).remove()}),r.error(function(e){alert("Error occured deleting story.Please try again later")})},_getBigImageUrl:function(e){var t=e.url_s;return t}};return i})