define(["jquery","ajax-scroll","moment","twitter_grid","notification","css!storiesListCss"],function(e,t,n,r,i){var s={config:{LATEST_STORIES_URL:"/latestStories"},notif:i,storiesRequestParams:{rowsToSkip:0,storiesToShow:12,dateFormat:n,userName:null,editMode:!1,lastStoryId:null,itemsPerRow:3},searchStories:function(t,n){e(t).empty(),s.showLatest(t,n)},showLatest:function(t,n){s.storiesRequestParams=e.extend(!0,s.storiesRequestParams,n),s._bindInfiniteScroll(t),s._getStories(t)},_bindInfiniteScroll:function(t){e(window).paged_scroll({handleScroll:function(e,n,r){s.storiesRequestParams.rowsToSkip=e*s.storiesRequestParams.storiesToShow,s._getStories(t),r()},startPage:1,targetElement:e(t),step:"50%",debug:!1,monitorTargetChange:!1})},_getStories:function(e){var t=function(t){console.log("User stories are :",t),s._render(t,e)};s._getLatestStories(t)},_getLatestStories:function(t){var n=e.ajax({url:s.config.LATEST_STORIES_URL,dataType:"json",data:s.storiesRequestParams,cache:!1});n.success(function(e){t(e)}),n.error(function(e){s.render(null)})},_render:function(t,n){if(!t)return;r.gridify({element:n,data:t,itemsPerRow:s.storiesRequestParams.itemsPerRow,getItemContent:function(t,n,r){if(t){var i=e('<div class="storyCont" data-content="contentItem" />').appendTo(n);s._renderStory(t,i)}}})},_renderStory:function(t,r){var o=t.title,u=t.tags,a=t.items[0],f=t.url,l=n(t.publishDate).fromNow(),c=t.interests?t.interests.join(" "):"",h=s._getBigImageUrl(a);if(s.storiesRequestParams.editMode===!0)var p=t.isPublished;if(t.storyUserText)var d=e("<div class='storyUserText'>"+t.storyUserText+"</div>").appendTo(r);var v=e("<div class='storyHeader'></div>").appendTo(r),m=e('<div class="widgetItemName" />').appendTo(v);e('<a class="storyContainer" href="'+f+'">'+o+"<a/>").appendTo(m);var g=e('<div class="storyImageCont"><a class="storyContainer" href="'+f+'"><img class="imgStory" src="'+h+'"/></a></div>').appendTo(r);e(".imgStory",r).css({height:a.height_s,width:a.width_s}),e('<div class="tags"><div class="tagsTitle">Tags</div><div class="tagsText"> '+c+"</div></div>").appendTo(r),e('<div class="userLink"><span>By : </span><a href="/stories/'+t.userName+'">'+t.userName+"</a></div>").appendTo(r);if(s.storiesRequestParams.editMode===!0){var y=e('<div class="editLinks"><a class="editStory" href="'+t.editUrl+'">Edit</a><a class="deleteStory" href="'+t.deleteUrl+'">Delete<a></div>').appendTo(r);p?e("<span class='isPublished'>Published</span>").appendTo(y):e("<span class='draft'>Draft</span>").appendTo(y),e(".deleteStory",y).on("click",function(t){t.preventDefault();var n=confirm("Are you really want to delete this story? You can't undo this action"),o=e(this).attr("href");n&&(s._deleteStory(o,r),i("Story deleted"))})}},_deleteStory:function(t,n){var r=e.ajax({url:t,dataType:"json",cache:!1});r.success(function(t){t.status==="ok"&&e(n).remove()}),r.error(function(e){alert("Error occured deleting story.Please try again later")})},_getBigImageUrl:function(e){var t=e.url_s;return t}};return s})