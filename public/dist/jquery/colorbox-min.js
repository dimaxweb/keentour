// Copyright (c) 2011 Jack Moore - jack@colorpowered.com

// Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php

(function(e,t,n){function r(n,r,i){var s=t.createElement(n);return r&&(s.id=p+r),i&&(s.style.cssText=i),e(s)}function i(e){var t=_.length,n=(Q+e)%t;return n<0?t+n:n}function s(e,t){return Math.round((/%/.test(e)?(t==="x"?D.width():D.height())/100:1)*parseInt(e,10))}function o(e){return W.photo||/\.(gif|png|jpe?g|bmp|ico)((#|\?).*)?$/i.test(e)}function u(){var t;W=e.extend({},e.data(K,h));for(t in W)e.isFunction(W[t])&&t.slice(0,2)!=="on"&&(W[t]=W[t].call(K));W.rel=W.rel||K.rel||"nofollow",W.href=W.href||e(K).attr("href"),W.title=W.title||K.title,typeof W.href=="string"&&(W.href=e.trim(W.href))}function a(t,n){e.event.trigger(t),n&&n.call(K)}function f(){var e,t=p+"Slideshow_",n="click."+p,r,i,s;W.slideshow&&_[1]?(r=function(){I.text(W.slideshowStop).unbind(n).bind(g,function(){if(Q<_.length-1||W.loop)e=setTimeout(nt.next,W.slideshowSpeed)}).bind(m,function(){clearTimeout(e)}).one(n+" "+y,i),N.removeClass(t+"off").addClass(t+"on"),e=setTimeout(nt.next,W.slideshowSpeed)},i=function(){clearTimeout(e),I.text(W.slideshowStart).unbind([g,m,y,n].join(" ")).one(n,function(){nt.next(),r()}),N.removeClass(t+"on").addClass(t+"off")},W.slideshowAuto?r():i()):N.removeClass(t+"off "+t+"on")}function l(t){if(!et){K=t,u(),_=e(K),Q=0,W.rel!=="nofollow"&&(_=e("."+d).filter(function(){var t=e.data(this,h).rel||this.rel;return t===W.rel}),Q=_.index(K),Q===-1&&(_=_.add(K),Q=_.length-1));if(!Y){Y=Z=!0,N.show();if(W.returnFocus)try{K.blur(),e(K).one(b,function(){try{this.focus()}catch(e){}})}catch(n){}T.css({opacity:+W.opacity,cursor:W.overlayClose?"pointer":"auto"}).show(),W.w=s(W.initialWidth,"x"),W.h=s(W.initialHeight,"y"),nt.position(),S&&D.bind("resize."+x+" scroll."+x,function(){T.css({width:D.width(),height:D.height(),top:D.scrollTop(),left:D.scrollLeft()})}).trigger("resize."+x),a(v,W.onOpen),z.add(j).hide(),U.html(W.close).show()}nt.load(!0)}}var c={transition:"elastic",speed:300,width:!1,initialWidth:"600",innerWidth:!1,maxWidth:!1,height:!1,initialHeight:"450",innerHeight:!1,maxHeight:!1,scalePhotos:!0,scrolling:!0,inline:!1,html:!1,iframe:!1,fastIframe:!0,photo:!1,href:!1,title:!1,rel:!1,opacity:.9,preloading:!0,current:"image {current} of {total}",previous:"previous",next:"next",close:"close",open:!1,returnFocus:!0,loop:!0,slideshow:!1,slideshowAuto:!0,slideshowSpeed:2500,slideshowStart:"start slideshow",slideshowStop:"stop slideshow",onOpen:!1,onLoad:!1,onComplete:!1,onCleanup:!1,onClosed:!1,overlayClose:!0,escKey:!0,arrowKey:!0,top:!1,bottom:!1,left:!1,right:!1,fixed:!1,data:undefined},h="colorbox",p="cbox",d=p+"Element",v=p+"_open",m=p+"_load",g=p+"_complete",y=p+"_cleanup",b=p+"_closed",w=p+"_purge",E=e.browser.msie&&!e.support.opacity,S=E&&e.browser.version<7,x=p+"_IE6",T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt="div";nt=e.fn[h]=e[h]=function(t,n){var r=this;t=t||{},nt.init();if(!r[0]){if(r.selector)return r;r=e("<a/>"),t.open=!0}return n&&(t.onComplete=n),r.each(function(){e.data(this,h,e.extend({},e.data(this,h)||c,t)),e(this).addClass(d)}),(e.isFunction(t.open)&&t.open.call(r)||t.open)&&l(r[0]),r},nt.init=function(){if(!N){if(!e("body")[0]){e(nt.init);return}D=e(n),N=r(rt).attr({id:h,"class":E?p+(S?"IE6":"IE"):""}),T=r(rt,"Overlay",S?"position:absolute":"").hide(),C=r(rt,"Wrapper"),k=r(rt,"Content").append(P=r(rt,"LoadedContent","width:0; height:0; overflow:hidden"),B=r(rt,"LoadingOverlay").add(r(rt,"LoadingGraphic")),j=r(rt,"Title"),F=r(rt,"Current"),q=r(rt,"Next"),R=r(rt,"Previous"),I=r(rt,"Slideshow").bind(v,f),U=r(rt,"Close")),C.append(r(rt).append(r(rt,"TopLeft"),L=r(rt,"TopCenter"),r(rt,"TopRight")),r(rt,!1,"clear:left").append(A=r(rt,"MiddleLeft"),k,O=r(rt,"MiddleRight")),r(rt,!1,"clear:left").append(r(rt,"BottomLeft"),M=r(rt,"BottomCenter"),r(rt,"BottomRight"))).find("div div").css({"float":"left"}),H=r(rt,!1,"position:absolute; width:9999px; visibility:hidden; display:none"),e("body").prepend(T,N.append(C,H)),X=L.height()+M.height()+k.outerHeight(!0)-k.height(),V=A.width()+O.width()+k.outerWidth(!0)-k.width(),$=P.outerHeight(!0),J=P.outerWidth(!0),N.css({"padding-bottom":X,"padding-right":V}).hide(),q.click(function(){nt.next()}),R.click(function(){nt.prev()}),U.click(function(){nt.close()}),z=q.add(R).add(F).add(I),T.click(function(){W.overlayClose&&nt.close()}),e(t).bind("keydown."+p,function(e){var t=e.keyCode;Y&&W.escKey&&t===27&&(e.preventDefault(),nt.close()),Y&&W.arrowKey&&_[1]&&(t===37?(e.preventDefault(),R.click()):t===39&&(e.preventDefault(),q.click()))})}},nt.remove=function(){N.add(T).remove(),N=null,e("."+d).removeData(h).removeClass(d)},nt.position=function(e,t){function n(e){L[0].style.width=M[0].style.width=k[0].style.width=e.style.width,B[0].style.height=B[1].style.height=k[0].style.height=A[0].style.height=O[0].style.height=e.style.height}var r=0,i=0,o=N.offset();D.unbind("resize."+p),N.css({top:-99999,left:-99999}),W.fixed&&!S?N.css({position:"fixed"}):(r=D.scrollTop(),i=D.scrollLeft(),N.css({position:"absolute"})),W.right!==!1?i+=Math.max(D.width()-W.w-J-V-s(W.right,"x"),0):W.left!==!1?i+=s(W.left,"x"):i+=Math.round(Math.max(D.width()-W.w-J-V,0)/2),W.bottom!==!1?r+=Math.max(D.height()-W.h-$-X-s(W.bottom,"y"),0):W.top!==!1?r+=s(W.top,"y"):r+=Math.round(Math.max(D.height()-W.h-$-X,0)/2),N.css({top:o.top,left:o.left}),e=N.width()===W.w+J&&N.height()===W.h+$?0:e||0,C[0].style.width=C[0].style.height="9999px",N.dequeue().animate({width:W.w+J,height:W.h+$,top:r,left:i},{duration:e,complete:function(){n(this),Z=!1,C[0].style.width=W.w+J+V+"px",C[0].style.height=W.h+$+X+"px",t&&t(),setTimeout(function(){D.bind("resize."+p,nt.position)},1)},step:function(){n(this)}})},nt.resize=function(e){Y&&(e=e||{},e.width&&(W.w=s(e.width,"x")-J-V),e.innerWidth&&(W.w=s(e.innerWidth,"x")),P.css({width:W.w}),e.height&&(W.h=s(e.height,"y")-$-X),e.innerHeight&&(W.h=s(e.innerHeight,"y")),!e.innerHeight&&!e.height&&(P.css({height:"auto"}),W.h=P.height()),P.css({height:W.h}),nt.position(W.transition==="none"?0:W.speed))},nt.prep=function(t){function n(){return W.w=W.w||P.width(),W.w=W.mw&&W.mw<W.w?W.mw:W.w,W.w}function s(){return W.h=W.h||P.height(),W.h=W.mh&&W.mh<W.h?W.mh:W.h,W.h}if(!Y)return;var u,f=W.transition==="none"?0:W.speed;P.remove(),P=r(rt,"LoadedContent").append(t),P.hide().appendTo(H.show()).css({width:n(),overflow:W.scrolling?"auto":"hidden"}).css({height:s()}).prependTo(k),H.hide(),e(G).css({"float":"none"}),S&&e("select").not(N.find("select")).filter(function(){return this.style.visibility!=="hidden"}).css({visibility:"hidden"}).one(y,function(){this.style.visibility="inherit"}),u=function(){function t(){E&&N[0].style.removeAttribute("filter")}var n,s,u=_.length,l,c="frameBorder",d="allowTransparency",v,m,y;if(!Y)return;v=function(){clearTimeout(tt),B.hide(),a(g,W.onComplete)},E&&G&&P.fadeIn(100),j.html(W.title).add(P).show();if(u>1){typeof W.current=="string"&&F.html(W.current.replace("{current}",Q+1).replace("{total}",u)).show(),q[W.loop||Q<u-1?"show":"hide"]().html(W.next),R[W.loop||Q?"show":"hide"]().html(W.previous),W.slideshow&&I.show();if(W.preloading){n=[i(-1),i(1)];while(s=_[n.pop()])m=e.data(s,h).href||s.href,e.isFunction(m)&&(m=m.call(s)),o(m)&&(y=new Image,y.src=m)}}else z.hide();W.iframe?(l=r("iframe")[0],c in l&&(l[c]=0),d in l&&(l[d]="true"),l.name=p+ +(new Date),W.fastIframe?v():e(l).one("load",v),l.src=W.href,W.scrolling||(l.scrolling="no"),e(l).addClass(p+"Iframe").appendTo(P).one(w,function(){l.src="//about:blank"})):v(),W.transition==="fade"?N.fadeTo(f,1,t):t()},W.transition==="fade"?N.fadeTo(f,0,function(){nt.position(0,u)}):nt.position(f,u)},nt.load=function(t){var n,i,f=nt.prep;Z=!0,G=!1,K=_[Q],t||u(),a(w),a(m,W.onLoad),W.h=W.height?s(W.height,"y")-$-X:W.innerHeight&&s(W.innerHeight,"y"),W.w=W.width?s(W.width,"x")-J-V:W.innerWidth&&s(W.innerWidth,"x"),W.mw=W.w,W.mh=W.h,W.maxWidth&&(W.mw=s(W.maxWidth,"x")-J-V,W.mw=W.w&&W.w<W.mw?W.w:W.mw),W.maxHeight&&(W.mh=s(W.maxHeight,"y")-$-X,W.mh=W.h&&W.h<W.mh?W.h:W.mh),n=W.href,tt=setTimeout(function(){B.show()},100),W.inline?(r(rt).hide().insertBefore(e(n)[0]).one(w,function(){e(this).replaceWith(P.children())}),f(e(n))):W.iframe?f(" "):W.html?f(W.html):o(n)?(e(G=new Image).addClass(p+"Photo").error(function(){W.title=!1,f(r(rt,"Error").text("This image could not be loaded"))}).load(function(){var e;G.onload=null,W.scalePhotos&&(i=function(){G.height-=G.height*e,G.width-=G.width*e},W.mw&&G.width>W.mw&&(e=(G.width-W.mw)/G.width,i()),W.mh&&G.height>W.mh&&(e=(G.height-W.mh)/G.height,i())),W.h&&(G.style.marginTop=Math.max(W.h-G.height,0)/2+"px"),_[1]&&(Q<_.length-1||W.loop)&&(G.style.cursor="pointer",G.onclick=function(){nt.next()}),E&&(G.style.msInterpolationMode="bicubic"),setTimeout(function(){f(G)},1)}),setTimeout(function(){G.src=n},1)):n&&H.load(n,W.data,function(t,n,i){f(n==="error"?r(rt,"Error").text("Request unsuccessful: "+i.statusText):e(this).contents())})},nt.next=function(){!Z&&_[1]&&(Q<_.length-1||W.loop)&&(Q=i(1),nt.load())},nt.prev=function(){!Z&&_[1]&&(Q||W.loop)&&(Q=i(-1),nt.load())},nt.close=function(){Y&&!et&&(et=!0,Y=!1,a(y,W.onCleanup),D.unbind("."+p+" ."+x),T.fadeTo(200,0),N.stop().fadeTo(300,0,function(){N.add(T).css({opacity:1,cursor:"auto"}).hide(),a(w),P.remove(),setTimeout(function(){et=!1,a(b,W.onClosed)},1)}))},nt.element=function(){return e(K)},nt.settings=c,e("."+d,t).live("click",function(e){e.which>1||e.shiftKey||e.altKey||e.metaKey||(e.preventDefault(),l(this))}),nt.init()})(jQuery,document,this)